<script>
const events = [
    {
        "name": "ICP InnoHack 2025 Application Deadline",
        "date": "2025-04-02",
        "start": "23:00:00",
        "description_top": "First Ever mini hackathon in ICP",
        "description_bottom": "<a href=''>Apply now!</a>",
        "timezone": "Asia/Kathmandu",
        "repeat": "none",
    },
    {
        "name": "Developers Session {i}",
        "date": "2025-03-23",
        "start": "15:00:00",
        "description_top": "",
        "description_bottom": "Every Sunday 3PM @ Rupa",
        "timezone": "Asia/Kathmandu",
        "repeat": "weekly",
        "weekdays": [0],
        "start_at": 3,
        "end_at": 10
    }
];

// Function to get the next occurrence of a recurring event
function getNextRecurringEventDate(event) {
    if (event.repeat !== "weekly") return null;

    const now = new Date();
    const startDate = new Date(event.date);
    const eventTime = event.start.split(':').map(Number);

    // Set the initial event datetime
    startDate.setHours(eventTime[0], eventTime[1], eventTime[2]);

    // If the start date is in the future, return it
    if (startDate > now) return startDate;

    // Calculate next occurrence
    const dayOfWeek = event.weekdays[0]; // Assuming only one weekday for simplicity
    const currentDay = now.getDay();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    const currentSeconds = now.getSeconds();

    let daysToAdd = (dayOfWeek - currentDay + 7) % 7;
    if (daysToAdd === 0) {
        // Same day, check if time has passed
        if (currentHours > eventTime[0] ||
            (currentHours === eventTime[0] && currentMinutes > eventTime[1]) ||
            (currentHours === eventTime[0] && currentMinutes === eventTime[1] && currentSeconds >= eventTime[2])) {
            daysToAdd = 7; // Next week
        }
    }

    const nextDate = new Date(now);
    nextDate.setDate(now.getDate() + daysToAdd);
    nextDate.setHours(eventTime[0], eventTime[1], eventTime[2]);

    const weekNumber = Math.floor((nextDate - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1;
    if (weekNumber > event.end_at) return null; // Event series has ended

    return nextDate;
}

// Function to create countdown timer for an event
function createCountdown(event, elementId) {
    const container = document.getElementById(elementId);
    if (!container) return;

    let targetDate;

    if (event.repeat === "none") {
        // Non-recurring event
        targetDate = new Date(`${event.date}T${event.start}`);
    } else if (event.repeat === "weekly") {
        // Recurring event - get next occurrence
        targetDate = getNextRecurringEventDate(event);
        if (!targetDate) {
            container.innerHTML = `<h3>${event.name}</h3><p>Event series has ended</p>`;
            return;
        }
    } else {
        // Unsupported recurrence
        container.innerHTML = `<h3>${event.name}</h3><p>Unsupported recurrence pattern</p>`;
        return;
    }

    // Update the countdown every second
    const timer = setInterval(() => {
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
            clearInterval(timer);
            if (event.repeat === "none") {
                container.innerHTML = `<h3>${event.name}</h3><p>Event has ended</p>`;
            } else {
                // For recurring events, get the next occurrence
                targetDate = getNextRecurringEventDate(event);
                if (!targetDate) {
                    container.innerHTML = `<h3>${event.name}</h3><p>Event series has ended</p>`;
                } else {
                    // Restart the timer for the next occurrence
                    createCountdown(event, elementId);
                }
            }
            return;
        }

        // Calculate time components
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        // Format the event name (replace {i} with week number if needed)
        let eventName = event.name;
        if (event.repeat === "weekly" && event.name.includes("{i}")) {
            const weekNumber = Math.floor((targetDate - new Date(event.date)) / (7 * 24 * 60 * 60 * 1000)) + 1;
            eventName = event.name.replace("{i}", weekNumber);
        }

        // Display the countdown
        container.innerHTML = `
            <h3>${eventName}</h3>
            ${event.description_top ? `<p>${event.description_top}</p>` : ''}
            <div class="countdown">
                <div>${days}<span>Days</span></div>
                <div>${hours}<span>Hours</span></div>
                <div>${minutes}<span>Minutes</span></div>
                <div>${seconds}<span>Seconds</span></div>
            </div>
            ${event.description_bottom ? `<p>${event.description_bottom}</p>` : ''}
            <p>${targetDate.toLocaleString('en-US', {
                timeZone: event.timezone,
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })} (${event.timezone})</p>
        `;
    }, 1000);
}

// Initialize countdowns for all events
document.addEventListener('DOMContentLoaded', () => {
    events.forEach((event, index) => {
        createCountdown(event, `event-container-${index}`);
    });
});
    </script>

<div id="event-container-0"></div>
<div id="event-container-1"></div>


<style>
    .countdown {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
}

.countdown div {
    text-align: center;
    background: #f0f0f0;
    padding: 0.5rem;
    border-radius: 5px;
    min-width: 60px;
}

.countdown span {
    display: block;
    font-size: 0.8rem;
    color: #666;
}
</style>
